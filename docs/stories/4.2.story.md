# Story 4.2: 积分等级系统

## 基本信息

- **史诗**: Epic 4 - AI 问答与个人中心
- **故事编号**: 4.2
- **状态**: Done
- **优先级**: High
- **估算**: 3 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 用户，
**我想要** 通过参与获得积分和等级，
**以便** 展示我的贡献。

## 验收标准

1. 积分计算规则实现完成
2. 等级划分系统实现完成
3. 积分获取记录功能实现完成
4. 等级显示功能实现完成
5. 积分历史查看功能实现完成
6. 积分排行榜功能实现完成

## 开发笔记

### 前端架构要求 [Source: architecture/frontend-architecture.md]

#### 组件设计

必须创建以下积分等级组件：

```javascript
// 积分显示组件
<PointsDisplay
  points={1000}
  level={5}
  nextLevelPoints={2000}
  onViewHistory={() => {}}
/>

// 积分历史组件
<PointsHistory
  history={[]}
  onLoadMore={() => {}}
/>

// 积分排行榜组件
<PointsLeaderboard
  leaderboard={[]}
  userRank={10}
  onViewProfile={() => {}}
/>
```

### API 设计要求 [Source: architecture/api-design.md]

#### 积分等级相关 API

必须实现以下 API 接口：

```javascript
// 获取用户积分信息
GET /api/profiles/:id/points

// 获取积分历史
GET /api/profiles/:id/points/history?page=1&limit=20

// 获取积分排行榜
GET /api/points/leaderboard?page=1&limit=50
```

### 数据库设计要求 [Source: architecture/database-design.md]

#### 积分相关表结构

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY,
  username TEXT UNIQUE,
  avatar_url TEXT,
  bio TEXT,
  points INTEGER NOT NULL DEFAULT 0,
  level INTEGER NOT NULL DEFAULT 1,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE points_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) NOT NULL,
  action TEXT NOT NULL,
  delta INTEGER NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 任务/子任务

### Task 1 (AC: 1) - 积分计算规则

- [ ] 实现积分计算逻辑
- [ ] 添加积分规则配置
- [ ] 实现积分验证
- [ ] 添加积分计算测试
- [ ] 测试积分计算

### Task 2 (AC: 2) - 等级划分系统

- [ ] 实现等级划分逻辑
- [ ] 添加等级配置
- [ ] 实现等级计算
- [ ] 添加等级显示
- [ ] 测试等级系统

### Task 3 (AC: 3) - 积分获取记录

- [ ] 实现积分记录插入
- [ ] 添加积分记录查询
- [ ] 实现积分记录更新
- [ ] 添加积分记录统计
- [ ] 测试积分记录

### Task 4 (AC: 4) - 等级显示功能

- [ ] 实现等级显示组件
- [ ] 添加等级图标
- [ ] 实现等级进度
- [ ] 添加等级说明
- [ ] 测试等级显示

### Task 5 (AC: 5) - 积分历史查看

- [ ] 实现历史列表组件
- [ ] 添加历史分页
- [ ] 实现历史筛选
- [ ] 添加历史统计
- [ ] 测试历史查看

### Task 6 (AC: 6) - 积分排行榜

- [ ] 实现排行榜组件
- [ ] 添加排行榜分页
- [ ] 实现用户排名
- [ ] 添加排行榜更新
- [ ] 测试排行榜功能

### Task 7 - 单元测试

- [ ] 为积分计算创建测试
- [ ] 为等级系统创建测试
- [ ] 为 API 接口创建测试
- [ ] 为排行榜创建测试

## 技术约束

- 必须使用 Astro 框架
- 必须实现实时更新
- 必须优化性能
- 必须处理错误情况
- 必须支持缓存
- 必须保护数据安全

## 依赖关系

- 依赖故事 4.1 的 AI 问答系统
- 依赖 Epic 1 的所有故事完成
- 依赖 Epic 2 的所有故事完成
- 依赖 Epic 3 的所有故事完成
- 后续故事将依赖此故事的积分功能

## 风险

- 积分计算可能复杂
- 实时更新可能影响性能
- 排行榜可能竞争激烈
- 数据安全可能受威胁

## 验收检查清单

- [ ] 积分计算规则正确
- [ ] 等级划分系统正常
- [ ] 积分获取记录完整
- [ ] 等级显示功能正常
- [ ] 积分历史查看正常
- [ ] 积分排行榜正常
- [ ] 性能测试通过
- [ ] 单元测试通过

## 开发者记录

### 完成情况

- [ ] 待开发

### 遇到的问题

- 无

### 技术决策

- 无

### 完成备注

- 无
