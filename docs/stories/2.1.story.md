# Story 2.1: 新闻抓取系统

## 基本信息

- **史诗**: Epic 2 - 新闻聚合与展示
- **故事编号**: 2.1
- **状态**: Done
- **优先级**: High
- **估算**: 5 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 系统管理员，
**我想要** 自动抓取多个来源的 AI 编程新闻，
**以便** 为用户提供丰富的内容。

## 验收标准

1. 20个新闻源配置完成，包含 RSS 和 API 源
2. 定时抓取函数实现完成，每日执行
3. 新闻去重逻辑实现完成，基于哈希值
4. 新闻分类和标签系统实现完成
5. 抓取日志记录系统实现完成
6. 错误处理和重试机制实现完成

## 开发笔记

### 新闻源配置要求 [Source: netlify/functions/fetch-news.js]

#### 已配置的新闻源
必须支持以下20个AI编程新闻源：
- OpenAI Blog
- DeepMind
- Google AI
- Microsoft Research
- Meta AI
- Stability AI
- Amazon Science
- Apple ML
- Hugging Face Blog
- The Gradient
- GitHub Blog AI
- MLOps Community
- Anthropic
- Papers with Code
- Amazon Science Blog
- Meta Research
- Google Research
- Azure AI Blog
- NVIDIA Technical Blog AI
- Open Source AI

#### 新闻源类型
- **RSS源**: 支持标准RSS格式
- **API源**: 支持REST API调用
- **混合源**: 支持多种数据格式

### 定时抓取函数要求 [Source: netlify.toml]

#### Netlify Functions配置
```toml
[[scheduled.functions]]
  name = "fetch-news"
  cron = "0 2 * * *"  # 每天凌晨2点执行
```

#### 函数功能要求
- 并行抓取多个新闻源
- 标准化数据格式
- 批量插入数据库
- 记录抓取日志

### 新闻去重逻辑要求 [Source: netlify/functions/fetch-news.js]

#### 哈希值生成
```javascript
const hash = sha1(title.trim().toLowerCase() + '|' + url.trim().toLowerCase() + '|' + (pub || ''));
```

#### 去重策略
- 基于标题+URL+发布时间的哈希值
- 使用数据库唯一约束防止重复
- 支持增量更新

### 新闻分类和标签系统 [Source: architecture/database-design.md]

#### 标签字段
- `tags`: TEXT[] 数组类型
- 支持自动标签提取
- 支持手动标签管理

#### 分类策略
- 按来源分类
- 按内容类型分类
- 按技术领域分类

### 抓取日志记录系统 [Source: architecture/database-design.md]

#### 日志表结构
```sql
CREATE TABLE crawler_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source VARCHAR(100) NOT NULL,
  status VARCHAR(20) NOT NULL,
  message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 日志记录内容
- 抓取源名称
- 抓取状态（成功/失败）
- 错误信息
- 抓取时间

### 错误处理和重试机制 [Source: netlify/functions/fetch-news.js]

#### 错误处理策略
- 单个源失败不影响其他源
- 记录详细错误信息
- 支持部分成功处理

#### 重试机制
- 网络错误自动重试
- 超时错误重试
- 最大重试次数限制

### 性能优化要求 [Source: architecture/performance-optimization.md]

#### 并发处理
- 并行抓取多个源
- 控制并发数量
- 避免资源竞争

#### 数据库优化
- 批量插入操作
- 使用事务保证一致性
- 索引优化查询性能

## 任务/子任务

### Task 1 (AC: 1) - 新闻源配置
- [ ] 配置20个RSS新闻源
- [ ] 配置API新闻源（如需要）
- [ ] 验证新闻源可访问性
- [ ] 测试新闻源数据格式
- [ ] 创建新闻源配置文件

### Task 2 (AC: 2) - 定时抓取函数
- [ ] 完善 `netlify/functions/fetch-news.js` 函数
- [ ] 配置定时执行计划
- [ ] 实现并行抓取逻辑
- [ ] 添加数据标准化处理
- [ ] 实现批量数据库插入

### Task 3 (AC: 3) - 新闻去重逻辑
- [ ] 实现哈希值生成算法
- [ ] 配置数据库唯一约束
- [ ] 实现增量更新逻辑
- [ ] 测试去重效果
- [ ] 优化去重性能

### Task 4 (AC: 4) - 分类和标签系统
- [ ] 实现自动标签提取
- [ ] 配置标签存储结构
- [ ] 实现标签管理功能
- [ ] 添加分类规则
- [ ] 测试标签系统

### Task 5 (AC: 5) - 抓取日志记录
- [ ] 完善crawler_logs表结构
- [ ] 实现日志记录功能
- [ ] 添加日志查询接口
- [ ] 实现日志清理策略
- [ ] 测试日志系统

### Task 6 (AC: 6) - 错误处理和重试
- [ ] 实现错误捕获机制
- [ ] 添加重试逻辑
- [ ] 配置重试参数
- [ ] 实现错误通知
- [ ] 测试错误处理

### Task 7 - 单元测试
- [ ] 为抓取函数创建测试
- [ ] 为去重逻辑创建测试
- [ ] 为错误处理创建测试
- [ ] 为日志系统创建测试

## 技术约束

- 必须使用Netlify Functions
- 必须使用Supabase数据库
- 必须支持RSS和API源
- 必须实现去重机制
- 必须记录抓取日志
- 必须处理错误情况

## 依赖关系

- 依赖Epic 1的所有故事完成
- 依赖故事1.2的数据库模型设计
- 后续故事将依赖此故事的新闻数据

## 风险

- 新闻源可能不稳定
- 抓取频率可能受限
- 数据量可能很大
- 错误处理复杂

## 验收检查清单

- [ ] 20个新闻源配置完成
- [ ] 定时抓取功能正常
- [ ] 去重逻辑有效
- [ ] 分类标签系统正常
- [ ] 日志记录完整
- [ ] 错误处理有效
- [ ] 单元测试通过
- [ ] 性能测试通过

## 开发者记录

### 完成情况
- [ ] 待开发

### 遇到的问题
- 无

### 技术决策
- 无

### 完成备注
- 无
