# Story 3.2: 社区列表展示

## 基本信息

- **史诗**: Epic 3 - 社区互动系统
- **故事编号**: 3.2
- **状态**: Done
- **优先级**: High
- **估算**: 3 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 用户，
**我想要** 浏览社区内容，
**以便** 参与讨论和获取帮助。

## 验收标准

1. 社区首页创建完成，支持标签页切换
2. 论坛标签页实现完成，显示用户发帖
3. 问答标签页实现完成，显示用户提问
4. 帖子排序功能实现完成（时间/热度）
5. 帖子分类筛选功能实现完成
6. 帖子搜索功能实现完成

## 开发笔记

### 前端架构要求 [Source: architecture/frontend-architecture.md]

#### 页面结构

必须创建以下社区相关页面：

```
src/pages/
  community.astro      # 社区首页
  post/[id].astro      # 帖子详情页面
```

#### 组件设计

必须创建以下社区组件：

```javascript
// 帖子卡片组件
<PostCard
  type="post|question"
  title="帖子标题"
  content="帖子内容"
  author="作者"
  createdAt="创建时间"
  likeCount={10}
  commentCount={5}
  onLike={() => {}}
  onComment={() => {}}
/>

// 标签页组件
<TabPanel
  tabs={["论坛", "问答"]}
  activeTab="论坛"
  onTabChange={() => {}}
/>
```

### API 设计要求 [Source: architecture/api-design.md]

#### 社区相关 API

必须实现以下 API 接口：

```javascript
// 获取帖子列表
GET /api/posts?type=post&page=1&limit=20&sort=time|hot

// 获取问答列表
GET /api/posts?type=question&page=1&limit=20&sort=time|hot

// 搜索帖子
GET /api/posts/search?q=关键词&type=post|question
```

### 数据库设计要求 [Source: architecture/database-design.md]

#### 帖子表结构

```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  author_id UUID REFERENCES profiles(id) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('post', 'question')),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  media TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 索引优化

```sql
CREATE INDEX idx_posts_type_created_at ON posts(type, created_at DESC);
CREATE INDEX idx_posts_author_id ON posts(author_id);
CREATE INDEX idx_posts_title_search ON posts USING GIN(to_tsvector('english', title));
```

### 排序功能要求 [Source: architecture/performance-optimization.md]

#### 排序算法

- 时间排序：按创建时间倒序
- 热度排序：按点赞数+评论数+浏览量
- 最新回复排序：按最后回复时间
- 推荐排序：基于用户兴趣

#### 排序优化

- 缓存排序结果
- 分页优化
- 实时更新
- 性能监控

## 任务/子任务

### Task 1 (AC: 1) - 社区首页

- [x] 创建 `src/pages/community.astro` 页面
- [x] 实现标签页切换
- [x] 添加响应式布局
- [x] 实现页面导航
- [x] 测试页面功能

### Task 2 (AC: 2) - 论坛标签页

- [x] 实现论坛帖子列表
- [x] 添加帖子卡片组件
- [x] 实现帖子展示
- [x] 添加帖子交互
- [x] 测试论坛功能

### Task 3 (AC: 3) - 问答标签页

- [x] 实现问答帖子列表
- [x] 添加问答标识
- [x] 实现问答展示
- [x] 添加问答交互
- [x] 测试问答功能

### Task 4 (AC: 4) - 帖子排序

- [x] 实现时间排序
- [x] 实现热度排序
- [x] 添加排序选择
- [x] 优化排序性能
- [x] 测试排序功能

### Task 5 (AC: 5) - 帖子筛选

- [x] 实现分类筛选
- [x] 添加筛选条件
- [x] 实现筛选逻辑
- [x] 添加筛选结果
- [x] 测试筛选功能

### Task 6 (AC: 6) - 帖子搜索

- [x] 实现搜索功能
- [x] 添加搜索建议
- [x] 实现搜索结果
- [x] 添加搜索历史
- [x] 测试搜索功能

### Task 7 - 单元测试

- [x] 为社区组件创建测试
- [x] 为 API 接口创建测试
- [x] 为排序功能创建测试
- [x] 为搜索功能创建测试

## 技术约束

- 必须使用 Astro 框架
- 必须支持响应式设计
- 必须实现排序功能
- 必须优化性能
- 必须处理错误情况
- 必须支持搜索功能

## 依赖关系

- 依赖故事 3.1 的社区发帖系统
- 依赖 Epic 1 的所有故事完成
- 依赖 Epic 2 的所有故事完成
- 后续故事将依赖此故事的列表展示

## 风险

- 大量数据可能影响性能
- 排序算法可能复杂
- 搜索功能可能不准确
- 用户体验可能不佳

## 验收检查清单

- [x] 社区首页正常显示
- [x] 论坛标签页正常
- [x] 问答标签页正常
- [x] 排序功能正常
- [x] 筛选功能正常
- [x] 搜索功能正常
- [x] 性能测试通过
- [x] 单元测试通过

## 开发者记录

### 完成情况

- [x] 所有任务已完成

### 遇到的问题

- TypeScript 类型错误：在 TabPanel 组件中使用 dataset 属性时出现类型错误，通过使用 setAttribute/getAttribute 方法解决
- 数据库字段缺失：posts 表缺少 like_count、comment_count、category 等字段，已添加相应字段和索引

### 技术决策

- 使用组件化设计：创建了 PostCard、TabPanel、SortFilter 等可复用组件
- 采用事件驱动架构：使用自定义事件处理标签页切换和筛选变化
- 优化数据库查询：添加了复合索引和全文搜索索引
- 响应式设计：使用 Tailwind CSS 实现移动端友好的界面

### 完成备注

- 创建了完整的社区列表展示功能
- 实现了论坛和问答的标签页切换
- 支持按时间、热度、最新回复排序
- 支持按分类筛选和关键词搜索
- 添加了加载状态和空状态处理
- 创建了完整的单元测试覆盖
- 添加了测试数据用于功能验证
