# Story 4.1: AI 问答系统

## 基本信息

- **史诗**: Epic 4 - AI 问答与个人中心
- **故事编号**: 4.1
- **状态**: Done
- **优先级**: High
- **估算**: 4 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 用户，
**我想要** 向 AI 提问，
**以便** 获得编程相关的帮助。

## 验收标准

1. AI 问答页面创建完成
2. 问题输入界面实现完成
3. AI 回答展示功能实现完成
4. 问题历史记录功能实现完成
5. 问题分享功能实现完成
6. 错误处理机制实现完成

## 开发笔记

### 前端架构要求 [Source: architecture/frontend-architecture.md]

#### 页面结构

必须创建以下 AI 问答相关页面：

```
src/pages/
  ask.astro           # AI 问答页面
```

#### 组件设计

必须创建以下 AI 问答组件：

```javascript
// AI问答组件
<AskAI
  onSubmit={() => {}}
  onHistory={() => {}}
  onShare={() => {}}
/>

// 问题输入组件
<QuestionInput
  placeholder="请输入您的问题..."
  onSubmit={() => {}}
  onClear={() => {}}
/>

// AI回答组件
<AIAnswer
  answer="AI回答内容"
  isLoading={false}
  onCopy={() => {}}
  onShare={() => {}}
/>
```

### API 设计要求 [Source: architecture/api-design.md]

#### AI 问答相关 API

必须实现以下 API 接口：

```javascript
// 提交问题给AI
POST /api/ask-ai
{
  "question": "问题内容",
  "authorId": "用户ID"
}

// 获取问答历史
GET /api/ask-ai/history?user_id=uuid&page=1&limit=20
```

### Netlify Functions 要求 [Source: netlify/functions/ask-ai.js]

#### AI 问答函数

必须完善以下函数：

```javascript
// netlify/functions/ask-ai.js
export default async (request, context) => {
  // 1. 验证用户身份
  // 2. 调用 AI API
  // 3. 记录问答历史
  // 4. 返回结果
};
```

### 数据库设计要求 [Source: architecture/database-design.md]

#### 问答表结构

```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  author_id UUID REFERENCES profiles(id) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('post', 'question')),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  media TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE answers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  question_id UUID REFERENCES posts(id) NOT NULL,
  author_id UUID REFERENCES profiles(id) NOT NULL,
  content TEXT NOT NULL,
  media TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 任务/子任务

### Task 1 (AC: 1) - AI 问答页面

- [ ] 创建 `src/pages/ask.astro` 页面
- [ ] 实现 AI 问答组件
- [ ] 添加响应式布局
- [ ] 实现页面导航
- [ ] 测试页面功能

### Task 2 (AC: 2) - 问题输入界面

- [ ] 实现问题输入组件
- [ ] 添加输入验证
- [ ] 实现输入提示
- [ ] 添加输入历史
- [ ] 测试输入功能

### Task 3 (AC: 3) - AI 回答展示

- [ ] 实现 AI 回答组件
- [ ] 添加回答格式化
- [ ] 实现代码高亮
- [ ] 添加回答复制
- [ ] 测试回答展示

### Task 4 (AC: 4) - 问题历史记录

- [ ] 实现历史记录组件
- [ ] 添加历史分页
- [ ] 实现历史搜索
- [ ] 添加历史删除
- [ ] 测试历史功能

### Task 5 (AC: 5) - 问题分享功能

- [ ] 实现分享组件
- [ ] 添加分享链接
- [ ] 实现分享复制
- [ ] 添加分享统计
- [ ] 测试分享功能

### Task 6 (AC: 6) - 错误处理机制

- [ ] 实现错误捕获
- [ ] 添加错误提示
- [ ] 实现重试机制
- [ ] 添加错误日志
- [ ] 测试错误处理

### Task 7 - 单元测试

- [ ] 为 AI 问答组件创建测试
- [ ] 为 API 接口创建测试
- [ ] 为错误处理创建测试
- [ ] 为分享功能创建测试

## 技术约束

- 必须使用 Astro 框架
- 必须使用 Netlify Functions
- 必须集成 AI API
- 必须优化性能
- 必须处理错误情况
- 必须支持历史记录

## 依赖关系

- 依赖 Epic 1 的所有故事完成
- 依赖 Epic 2 的所有故事完成
- 依赖 Epic 3 的所有故事完成
- 后续故事将依赖此故事的 AI 功能

## 风险

- AI API 可能不稳定
- 响应时间可能较长
- 错误处理可能复杂
- 用户体验可能不佳

## 验收检查清单

- [ ] AI 问答页面正常显示
- [ ] 问题输入功能正常
- [ ] AI 回答正确展示
- [ ] 历史记录功能正常
- [ ] 分享功能正常工作
- [ ] 错误处理机制有效
- [ ] 性能测试通过
- [ ] 单元测试通过

## 开发者记录

### 完成情况

- [ ] 待开发

### 遇到的问题

- 无

### 技术决策

- 无

### 完成备注

- 无
