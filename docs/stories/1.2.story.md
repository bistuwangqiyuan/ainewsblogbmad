# Story 1.2: 数据库模型设计

## 基本信息

- **史诗**: Epic 1 - 基础架构与用户认证
- **故事编号**: 1.2
- **状态**: Done
- **优先级**: High
- **估算**: 3 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 系统架构师，
**我想要** 设计完整的数据库模型，
**以便** 支持所有业务功能。

## 验收标准

1. 用户表（profiles）设计完成，包含必要字段
2. 新闻表（news_items）设计完成，支持去重和分类
3. 帖子表（posts）设计完成，支持论坛和问答
4. 互动表（likes, favorites, comments）设计完成
5. 其他辅助表（views, points_log, messages等）设计完成
6. RLS 策略设计完成，确保数据安全

## 开发笔记

### 数据库设计要求 [Source: architecture/database-design.md]

#### 核心表结构

**用户相关表:**
- `profiles`: 用户资料表，包含用户名、头像、简介、积分、等级等字段
- `points_log`: 积分记录表，记录用户积分变动历史

**内容相关表:**
- `news_items`: 新闻表，支持标题、URL、来源、发布时间、摘要、作者、图片、标签、内容HTML、哈希值等字段
- `posts`: 帖子表，支持论坛和问答两种类型，包含作者、类型、标题、内容、媒体文件等字段
- `answers`: 回答表，关联问题帖子，包含回答者、内容、媒体文件等字段

**互动相关表:**
- `comments`: 评论表，支持对新闻、帖子、回答的评论
- `likes`: 点赞表，支持对新闻、帖子、回答的点赞，允许取消
- `favorites`: 收藏表，支持对新闻、帖子、回答的收藏，不允许删除
- `reports`: 举报表，支持对新闻、帖子、回答、评论的举报

**统计相关表:**
- `views`: 浏览量表，记录内容浏览记录
- `messages`: 消息表，支持用户间私信
- `notifications`: 通知表，支持系统通知和用户通知

**系统相关表:**
- `feedbacks`: 反馈表，支持用户反馈提交
- `sensitive_words`: 敏感词表，用于内容过滤
- `crawler_logs`: 抓取日志表，记录新闻抓取状态

#### 索引设计要求 [Source: architecture/database-design.md]

必须创建以下性能优化索引：
- 新闻表：发布时间、来源、哈希值索引
- 帖子表：类型+创建时间、作者ID索引
- 评论表：实体类型+实体ID索引
- 点赞表：实体类型+实体ID索引
- 收藏表：实体类型+实体ID索引
- 浏览量表：实体类型+实体ID索引
- 积分记录表：用户ID索引
- 消息表：发送者+接收者索引
- 通知表：用户ID索引

#### RLS 策略要求 [Source: architecture/database-design.md]

**启用RLS的表:**
- profiles, news_items, posts, answers, comments, likes, favorites, reports, views, points_log, messages, notifications, feedbacks

**策略类型:**
- 公共可读策略：新闻、帖子、回答、评论、点赞、收藏允许所有人读取
- 用户可写策略：用户只能操作自己的数据
- 私密数据策略：消息、通知、积分记录只允许用户访问自己的数据

### 安全设计要求 [Source: architecture/security-design.md]

- **认证安全**: 使用Supabase Auth进行邮箱密码认证，JWT令牌管理
- **数据安全**: 实施RLS行级安全控制，遵循最小权限原则
- **输入验证**: 前端+后端双重验证，防止恶意输入
- **敏感词过滤**: 实时内容检查，拦截违规内容

### 项目结构要求 [Source: architecture/source-tree.md]

数据库相关文件必须放置在以下位置：
```
supabase/
  schema.sql                # 表结构和索引
  policies.sql              # RLS策略
  functions.sql             # 触发器和函数
```

### 编码规范要求 [Source: architecture/coding-standards.md]

- 使用PostgreSQL语法，支持最新特性
- 表名使用snake_case命名
- 字段名使用snake_case命名
- 主键使用UUID类型
- 时间字段使用TIMESTAMP WITH TIME ZONE
- 所有表必须包含created_at字段
- 需要更新的表必须包含updated_at字段

## 任务/子任务

### Task 1 (AC: 1) - 用户表设计
- [x] 创建profiles表，包含id、username、avatar_url、bio、points、level、created_at、updated_at字段
- [x] 创建points_log表，包含id、user_id、action、delta、created_at字段
- [x] 设置profiles表与auth.users的关联关系
- [x] 创建相关索引

### Task 2 (AC: 2) - 新闻表设计
- [x] 创建news_items表，包含所有必要字段
- [x] 设置hash字段的唯一约束，用于去重
- [x] 创建published_at、source、hash索引
- [x] 设置适当的字段类型和约束

### Task 3 (AC: 3) - 帖子表设计
- [x] 创建posts表，支持post和question两种类型
- [x] 创建answers表，关联questions
- [x] 设置author_id与profiles表的关联
- [x] 创建type+created_at、author_id索引

### Task 4 (AC: 4) - 互动表设计
- [x] 创建comments表，支持多实体类型评论
- [x] 创建likes表，支持点赞和取消
- [x] 创建favorites表，支持收藏
- [x] 创建reports表，支持举报功能
- [x] 设置适当的唯一约束和索引

### Task 5 (AC: 5) - 辅助表设计
- [x] 创建views表，记录浏览统计
- [x] 创建messages表，支持私信功能
- [x] 创建notifications表，支持通知系统
- [x] 创建feedbacks表，支持用户反馈
- [x] 创建sensitive_words表，支持内容过滤
- [x] 创建crawler_logs表，记录抓取日志

### Task 6 (AC: 6) - RLS策略设计
- [x] 为所有表启用RLS
- [x] 创建公共可读策略
- [x] 创建用户可写策略
- [x] 创建私密数据策略
- [x] 测试策略的有效性

### Task 7 - 单元测试
- [x] 为数据库schema创建测试
- [x] 为RLS策略创建测试
- [x] 为索引性能创建测试

## 技术约束

- 必须使用PostgreSQL数据库
- 必须使用Supabase作为数据库服务
- 必须实施RLS行级安全控制
- 必须使用UUID作为主键
- 必须包含适当的索引优化
- 必须遵循编码规范中的命名约定

## 依赖关系

- 依赖故事1.1的基础架构搭建
- 后续故事将依赖此故事的数据库模型

## 风险

- RLS策略配置复杂，需要仔细测试
- 索引设计可能影响性能，需要监控
- 数据迁移需要考虑向后兼容性

## 验收检查清单

- [x] 所有表结构创建完成
- [x] 所有索引创建完成
- [x] 所有RLS策略配置完成
- [x] 数据库连接测试通过
- [x] 权限控制测试通过
- [x] 性能测试通过
- [x] 单元测试通过

## 开发者记录

### 完成情况
- [x] 已完成

### 遇到的问题
- 无

### 技术决策
- 使用PostgreSQL的snake_case命名规范
- 使用UUID作为主键类型
- 使用timestamptz作为时间字段类型
- 实施RLS行级安全控制
- 创建性能优化索引

### 完成备注
- 所有验收标准已全部完成
- 数据库schema设计完成，包含15个核心表
- RLS策略配置完成，确保数据安全
- 函数和触发器实现完成，支持业务逻辑
- 测试数据准备完成
- 单元测试通过，验证了所有功能
