# Story 3.3: 帖子详情页面

## 基本信息

- **史诗**: Epic 3 - 社区互动系统
- **故事编号**: 3.3
- **状态**: Done
- **优先级**: High
- **估算**: 3 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 用户，
**我想要** 查看帖子的详细内容和回复，
**以便** 参与讨论。

## 验收标准

1. 帖子详情页面创建完成
2. 帖子内容完整展示实现完成
3. 媒体文件展示功能实现完成
4. 帖子作者信息显示实现完成
5. 帖子发布时间显示实现完成
6. 帖子编辑功能实现完成（仅作者）

## 开发笔记

### 前端架构要求 [Source: architecture/frontend-architecture.md]

#### 页面结构

必须创建以下帖子详情页面：

```
src/pages/
  post/[id].astro      # 帖子详情页面
```

#### 组件设计

必须创建以下帖子详情组件：

```javascript
// 帖子详情组件
<PostDetail
  id="uuid"
  type="post|question"
  title="帖子标题"
  content="帖子内容"
  author="作者"
  createdAt="创建时间"
  media={[]}
  onEdit={() => {}}
  onDelete={() => {}}
/>

// 媒体展示组件
<MediaGallery
  media={[]}
  onView={() => {}}
  onDownload={() => {}}
/>
```

### API 设计要求 [Source: architecture/api-design.md]

#### 帖子详情 API

必须实现以下 API 接口：

```javascript
// 获取帖子详情
GET /api/posts/:id

// 更新帖子
PUT /api/posts/:id
{
  "title": "新标题",
  "content": "新内容",
  "media": ["url1", "url2"]
}

// 删除帖子
DELETE /api/posts/:id
```

### 数据库设计要求 [Source: architecture/database-design.md]

#### 帖子表结构

```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  author_id UUID REFERENCES profiles(id) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('post', 'question')),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  media TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 任务/子任务

### Task 1 (AC: 1) - 帖子详情页面

- [x] 创建 `src/pages/post/[id].astro` 页面
- [x] 实现帖子详情组件
- [x] 添加响应式布局
- [x] 实现内容渲染
- [x] 测试页面功能

### Task 2 (AC: 2) - 帖子内容展示

- [x] 实现 HTML 内容渲染
- [x] 添加 Markdown 支持
- [x] 实现代码高亮
- [x] 添加内容格式化
- [x] 测试内容显示

### Task 3 (AC: 3) - 媒体文件展示

- [x] 实现媒体画廊组件
- [x] 添加图片预览
- [x] 实现视频播放
- [x] 添加媒体下载
- [x] 测试媒体功能

### Task 4 (AC: 4) - 作者信息显示

- [x] 实现作者信息组件
- [x] 添加作者头像
- [x] 显示作者等级
- [x] 添加作者链接
- [x] 测试作者信息

### Task 5 (AC: 5) - 时间信息显示

- [x] 实现时间格式化
- [x] 添加相对时间
- [x] 显示编辑时间
- [x] 添加时间工具提示
- [x] 测试时间显示

### Task 6 (AC: 6) - 帖子编辑功能

- [x] 实现编辑权限检查
- [x] 添加编辑按钮
- [x] 实现编辑表单
- [x] 添加编辑确认
- [x] 测试编辑功能

### Task 7 - 单元测试

- [x] 为详情页面创建测试
- [x] 为 API 接口创建测试
- [x] 为编辑功能创建测试
- [x] 为媒体功能创建测试

## 技术约束

- 必须使用 Astro 框架
- 必须支持响应式设计
- 必须实现权限控制
- 必须优化页面性能
- 必须处理错误情况
- 必须支持媒体展示

## 依赖关系

- 依赖故事 3.1 的社区发帖系统
- 依赖故事 3.2 的社区列表展示
- 后续故事将依赖此故事的详情功能

## 风险

- 内容渲染可能复杂
- 权限控制可能出错
- 媒体加载可能慢
- 编辑功能可能冲突

## 验收检查清单

- [x] 帖子详情页面正常显示
- [x] 帖子内容完整展示
- [x] 媒体文件正常显示
- [x] 作者信息正确显示
- [x] 时间信息正确显示
- [x] 编辑功能正常工作
- [x] 性能测试通过
- [x] 单元测试通过

## 开发者记录

### 完成情况

- [x] 所有任务已完成

### 遇到的问题

- TypeScript 类型错误：在组件中使用 dataset 属性和自定义事件时出现类型错误，通过类型断言解决
- 组件渲染问题：Astro 组件的动态渲染需要特殊处理，使用字符串模板和内联组件

### 技术决策

- 使用组件化设计：创建了 PostDetail、MediaGallery、PostEditForm 等可复用组件
- 采用事件驱动架构：使用自定义事件处理用户交互
- 响应式设计：使用 Tailwind CSS 实现移动端友好的界面
- 权限控制：实现作者权限检查，只有作者可以编辑和删除帖子

### 完成备注

- 创建了完整的帖子详情页面功能
- 实现了帖子内容展示和媒体文件处理
- 支持图片预览、视频播放和文件下载
- 实现了作者信息显示和权限控制
- 添加了时间格式化和编辑时间显示
- 实现了完整的编辑功能（仅作者）
- 创建了完整的单元测试覆盖
- 优化了用户体验和界面设计
