# Story 1.3: 用户认证系统

## 基本信息

- **史诗**: Epic 1 - 基础架构与用户认证
- **故事编号**: 1.3
- **状态**: Done
- **优先级**: High
- **估算**: 4 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 用户，
**我想要** 通过邮箱密码注册和登录，
**以便** 能够使用系统的个人功能。

## 验收标准

1. 注册页面创建完成，支持邮箱密码注册
2. 登录页面创建完成，支持邮箱密码登录
3. 用户会话管理实现完成，支持持久化登录
4. 用户资料页面创建完成，支持基本信息编辑
5. 登出功能实现完成
6. 未登录用户访问限制实现完成

## 开发笔记

### 认证系统设计要求 [Source: architecture/security-design.md]

#### 认证安全

- **Supabase Auth**: 使用邮箱密码认证，JWT 令牌管理
- **会话管理**: 自动刷新令牌，安全存储
- **密码策略**: 强密码要求，密码哈希存储

#### 数据安全

- **RLS 策略**: 行级安全控制，最小权限原则
- **输入验证**: 前端+后端双重验证
- **敏感词过滤**: 实时内容检查，违规内容拦截

### 前端架构要求 [Source: architecture/frontend-architecture.md]

#### 页面结构

必须创建以下认证相关页面：

```
src/pages/
  auth.astro          # 登录注册页面
  me.astro            # 个人中心页面
```

#### 状态管理

用户状态管理要求：

```javascript
// 用户状态
const userStore = {
  user: null,
  profile: null,
  isAuthenticated: false
};
```

### API 设计要求 [Source: architecture/api-design.md]

#### 用户相关 API

必须实现以下 API 接口：

```javascript
// 获取用户资料
GET /api/profiles/:id

// 更新用户资料
PUT /api/profiles/:id
{
  "username": "新用户名",
  "bio": "个人简介"
}

// 获取积分记录
GET /api/profiles/:id/points

// 获取个人统计
GET /api/profiles/:id/stats
```

### 数据库设计要求 [Source: architecture/database-design.md]

#### 用户表结构

- `profiles`: 用户资料表，包含 id、username、avatar_url、bio、points、level、created_at、updated_at 字段
- `points_log`: 积分记录表，记录用户积分变动历史

#### RLS 策略

- 用户只能读取和更新自己的资料
- 积分记录只允许用户访问自己的数据
- 个人统计数据受 RLS 保护

### 项目结构要求 [Source: architecture/source-tree.md]

认证相关文件必须放置在以下位置：

```
src/
  pages/
    auth.astro              # 登录/注册页面
    me.astro                # 个人中心页面
  lib/
    supabaseClient.js       # Supabase 客户端单例
  components/
    AuthForm.astro          # 认证表单组件
    ProfileForm.astro       # 资料编辑组件
```

### 编码规范要求 [Source: architecture/coding-standards.md]

- 安全、可读、性能依次优先
- 绝不使用模拟/回退数据
- ES6+ 语法，无 TypeScript
- 组件化与小函数拆分
- 所有写入均受 RLS 控制
- 前端+后端双重验证

### 安全要求 [Source: architecture/security-design.md]

#### 输入验证

- 邮箱格式验证
- 密码强度验证（至少 8 位，包含字母和数字）
- 用户名唯一性验证
- 防止 XSS 攻击

#### 会话管理

- JWT 令牌自动刷新
- 安全存储用户会话
- 登出时清除所有会话数据

#### 访问控制

- 未登录用户访问限制
- 个人页面权限控制
- API 接口权限验证

## 任务/子任务

### Task 1 (AC: 1) - 注册页面创建

- [x] 创建 `src/pages/auth.astro` 页面
- [x] 实现注册表单组件 `src/components/AuthForm.astro`
- [x] 添加邮箱格式验证
- [x] 添加密码强度验证
- [x] 添加用户名唯一性检查
- [x] 实现注册成功提示和跳转

### Task 2 (AC: 2) - 登录页面创建

- [x] 在 `src/pages/auth.astro` 中添加登录表单
- [x] 实现登录表单验证
- [x] 添加记住登录状态功能
- [x] 实现登录失败错误提示
- [x] 实现登录成功跳转

### Task 3 (AC: 3) - 用户会话管理

- [x] 配置 Supabase Auth 客户端
- [x] 实现自动令牌刷新
- [x] 实现会话持久化存储
- [x] 添加全局用户状态管理
- [x] 实现路由守卫功能

### Task 4 (AC: 4) - 用户资料页面

- [x] 创建 `src/pages/me.astro` 个人中心页面
- [x] 实现 `src/components/ProfileForm.astro` 资料编辑组件
- [x] 添加头像上传功能
- [x] 添加个人简介编辑
- [x] 显示用户积分和等级
- [x] 显示用户统计信息

### Task 5 (AC: 5) - 登出功能

- [x] 在 Header 组件中添加登出按钮
- [x] 实现登出确认对话框
- [x] 清除所有会话数据
- [x] 跳转到首页
- [x] 更新导航菜单状态

### Task 6 (AC: 6) - 访问限制

- [x] 实现路由守卫中间件
- [x] 保护需要登录的页面
- [x] 重定向未登录用户到登录页
- [x] 保护 API 接口访问
- [x] 添加权限检查组件

### Task 7 - 单元测试

- [x] 为认证组件创建测试
- [x] 为 API 接口创建测试
- [x] 为权限控制创建测试
- [x] 为表单验证创建测试

## 技术约束

- 必须使用 Supabase Auth 进行认证
- 必须实施 RLS 行级安全控制
- 必须使用 JWT 令牌管理
- 必须实现前端+后端双重验证
- 必须遵循编码规范中的安全要求
- 不允许使用模拟/回退数据

## 依赖关系

- 依赖故事 1.1 的基础架构搭建
- 依赖故事 1.2 的数据库模型设计
- 后续故事将依赖此故事的认证系统

## 风险

- Supabase Auth 配置复杂，需要仔细测试
- 会话管理可能影响用户体验
- 权限控制需要全面测试
- 安全漏洞可能导致数据泄露

## 验收检查清单

- [x] 注册功能正常工作
- [x] 登录功能正常工作
- [x] 会话管理正常工作
- [x] 个人资料编辑功能正常
- [x] 登出功能正常工作
- [x] 访问限制正常工作
- [x] 单元测试通过
- [x] 安全测试通过

## 开发者记录

### 完成情况

- [x] 已完成

### 遇到的问题

- 无

### 技术决策

- 使用 Supabase Auth 进行邮箱密码认证
- 使用 JWT 令牌管理会话
- 实现自动令牌刷新和会话持久化
- 使用 RLS 行级安全控制保护数据

### 完成备注

- 所有验收标准已全部完成
- 认证系统完整实现，包含注册、登录、会话管理
- 用户资料页面实现，支持积分和统计显示
- 登出功能实现，支持会话清理
- 访问限制实现，保护需要登录的页面
- 单元测试通过，验证了所有认证功能
