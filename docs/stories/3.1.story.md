# Story 3.1: 社区发帖系统

## 基本信息

- **史诗**: Epic 3 - 社区互动系统
- **故事编号**: 3.1
- **状态**: Done
- **优先级**: High
- **估算**: 4 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 用户，
**我想要** 发布帖子和提问，
**以便** 与社区其他用户交流。

## 验收标准

1. 发帖页面创建完成，支持富文本编辑
2. 图片/视频上传功能实现完成（≤10MB，最多5个）
3. 帖子类型选择功能实现完成（论坛/问答）
4. 帖子预览功能实现完成
5. 帖子发布成功提示实现完成
6. 草稿保存功能实现完成

## 开发笔记

### 前端架构要求 [Source: architecture/frontend-architecture.md]

#### 页面结构
必须创建以下发帖相关页面：
```
src/pages/
  compose.astro        # 发帖/提问页面
```

#### 组件设计
必须创建以下发帖组件：
```javascript
// 发帖表单组件
<PostForm 
  type="post|question"
  title=""
  content=""
  media={[]}
  onSave={() => {}}
  onPublish={() => {}}
  onPreview={() => {}}
/>

// 富文本编辑器组件
<RichTextEditor 
  content=""
  onChange={() => {}}
  onSave={() => {}}
/>

// 媒体上传组件
<MediaUpload 
  files={[]}
  maxSize={10}
  maxCount={5}
  onUpload={() => {}}
  onRemove={() => {}}
/>
```

### API设计要求 [Source: architecture/api-design.md]

#### 帖子相关API
必须实现以下API接口：
```javascript
// 创建帖子
POST /api/posts
{
  "type": "post",
  "title": "标题",
  "content": "内容",
  "media": ["url1", "url2"]
}

// 保存草稿
POST /api/posts/draft
{
  "type": "post",
  "title": "标题",
  "content": "内容",
  "media": ["url1"]
}

// 上传媒体文件
POST /api/upload
{
  "file": File,
  "type": "image|video"
}
```

### 数据库设计要求 [Source: architecture/database-design.md]

#### 帖子表结构
```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  author_id UUID REFERENCES profiles(id) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('post', 'question')),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  media TEXT[],
  status VARCHAR(20) DEFAULT 'published' CHECK (status IN ('draft', 'published')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 索引优化
```sql
CREATE INDEX idx_posts_type_created_at ON posts(type, created_at DESC);
CREATE INDEX idx_posts_author_id ON posts(author_id);
CREATE INDEX idx_posts_status ON posts(status);
```

### 富文本编辑要求 [Source: architecture/frontend-architecture.md]

#### 编辑器功能
- 支持Markdown语法
- 支持代码高亮
- 支持图片插入
- 支持表格创建
- 支持链接插入

#### 编辑器优化
- 自动保存
- 实时预览
- 快捷键支持
- 撤销/重做

### 媒体上传要求 [Source: architecture/security-design.md]

#### 文件安全
- 文件类型验证
- 文件大小限制（≤10MB）
- 文件数量限制（最多5个）
- 恶意文件检测

#### 存储配置
- Supabase Storage存储
- 公开读，用户写权限
- 文件路径规范化
- 文件压缩优化

### 草稿功能要求 [Source: architecture/frontend-architecture.md]

#### 草稿管理
- 自动保存草稿
- 草稿列表显示
- 草稿恢复功能
- 草稿删除功能

#### 草稿同步
- 本地存储备份
- 云端同步
- 冲突解决
- 版本管理

## 任务/子任务

### Task 1 (AC: 1) - 发帖页面创建
- [ ] 创建 `src/pages/compose.astro` 页面
- [ ] 实现发帖表单组件
- [ ] 添加响应式布局
- [ ] 实现表单验证
- [ ] 测试页面功能

### Task 2 (AC: 2) - 富文本编辑
- [ ] 实现富文本编辑器
- [ ] 添加Markdown支持
- [ ] 实现代码高亮
- [ ] 添加图片插入
- [ ] 测试编辑功能

### Task 3 (AC: 3) - 媒体上传
- [ ] 实现文件上传组件
- [ ] 添加文件类型验证
- [ ] 实现文件大小限制
- [ ] 添加文件数量限制
- [ ] 测试上传功能

### Task 4 (AC: 4) - 帖子类型选择
- [ ] 实现类型选择组件
- [ ] 添加类型切换逻辑
- [ ] 实现类型验证
- [ ] 添加类型提示
- [ ] 测试类型功能

### Task 5 (AC: 5) - 帖子预览
- [ ] 实现预览组件
- [ ] 添加预览切换
- [ ] 实现预览样式
- [ ] 添加预览验证
- [ ] 测试预览功能

### Task 6 (AC: 6) - 草稿保存
- [ ] 实现草稿保存逻辑
- [ ] 添加自动保存
- [ ] 实现草稿列表
- [ ] 添加草稿恢复
- [ ] 测试草稿功能

### Task 7 - 单元测试
- [ ] 为发帖组件创建测试
- [ ] 为API接口创建测试
- [ ] 为文件上传创建测试
- [ ] 为草稿功能创建测试

## 技术约束

- 必须使用Astro框架
- 必须支持富文本编辑
- 必须实现文件上传
- 必须优化用户体验
- 必须处理错误情况
- 必须支持草稿功能

## 依赖关系

- 依赖Epic 1的所有故事完成
- 依赖Epic 2的所有故事完成
- 后续故事将依赖此故事的发帖功能

## 风险

- 富文本编辑可能复杂
- 文件上传可能失败
- 草稿同步可能冲突
- 用户体验可能不佳

## 验收检查清单

- [ ] 发帖页面正常显示
- [ ] 富文本编辑正常
- [ ] 媒体上传正常
- [ ] 类型选择正常
- [ ] 预览功能正常
- [ ] 草稿保存正常
- [ ] 性能测试通过
- [ ] 单元测试通过

## 开发者记录

### 完成情况
- [ ] 待开发

### 遇到的问题
- 无

### 技术决策
- 无

### 完成备注
- 无
