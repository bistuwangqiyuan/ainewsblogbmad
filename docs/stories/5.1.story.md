# Story 5.1: 站内消息系统

## 基本信息

- **史诗**: Epic 5 - 消息通知与反馈
- **故事编号**: 5.1
- **状态**: Done
- **优先级**: High
- **估算**: 3 hours
- **创建日期**: 2025-08-31
- **创建者**: Bob (SM)

## 用户故事

**作为** 用户，
**我想要** 与其他用户私信交流，
**以便** 进行深度讨论。

## 验收标准

1. 消息列表页面创建完成
2. 私信发送功能实现完成
3. 私信接收功能实现完成
4. 消息已读/未读状态实现完成
5. 消息搜索功能实现完成
6. 消息删除功能实现完成

## 开发笔记

### 前端架构要求 [Source: architecture/frontend-architecture.md]

#### 页面结构

必须创建以下消息相关页面：

```
src/pages/
  messages.astro        # 消息列表页面
```

#### 组件设计

必须创建以下消息组件：

```javascript
// 消息列表组件
<MessageList
  messages={[]}
  onSelect={() => {}}
  onDelete={() => {}}
/>

// 消息对话组件
<MessageChat
  conversation={[]}
  onSend={() => {}}
  onLoadMore={() => {}}
/>

// 消息搜索组件
<MessageSearch
  onSearch={() => {}}
  onClear={() => {}}
/>
```

### API 设计要求 [Source: architecture/api-design.md]

#### 消息相关 API

必须实现以下 API 接口：

```javascript
// 发送消息
POST /api/messages
{
  "recipient_id": "接收者ID",
  "content": "消息内容"
}

// 获取消息列表
GET /api/messages?page=1&limit=20

// 获取对话记录
GET /api/messages/conversation/:user_id?page=1&limit=50
```

### 数据库设计要求 [Source: architecture/database-design.md]

#### 消息表结构

```sql
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sender_id UUID REFERENCES profiles(id) NOT NULL,
  recipient_id UUID REFERENCES profiles(id) NOT NULL,
  content TEXT NOT NULL,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 任务/子任务

### Task 1 (AC: 1) - 消息列表页面

- [ ] 创建 `src/pages/messages.astro` 页面
- [ ] 实现消息列表组件
- [ ] 添加响应式布局
- [ ] 实现消息排序
- [ ] 测试页面功能

### Task 2 (AC: 2) - 私信发送功能

- [ ] 实现消息发送组件
- [ ] 添加发送验证
- [ ] 实现发送状态
- [ ] 添加发送确认
- [ ] 测试发送功能

### Task 3 (AC: 3) - 私信接收功能

- [ ] 实现消息接收组件
- [ ] 添加接收通知
- [ ] 实现接收状态
- [ ] 添加接收确认
- [ ] 测试接收功能

### Task 4 (AC: 4) - 消息已读状态

- [ ] 实现已读状态管理
- [ ] 添加已读标记
- [ ] 实现已读更新
- [ ] 添加已读统计
- [ ] 测试已读功能

### Task 5 (AC: 5) - 消息搜索功能

- [ ] 实现搜索组件
- [ ] 添加搜索逻辑
- [ ] 实现搜索结果
- [ ] 添加搜索历史
- [ ] 测试搜索功能

### Task 6 (AC: 6) - 消息删除功能

- [ ] 实现删除组件
- [ ] 添加删除确认
- [ ] 实现删除逻辑
- [ ] 添加删除恢复
- [ ] 测试删除功能

### Task 7 - 单元测试

- [ ] 为消息组件创建测试
- [ ] 为 API 接口创建测试
- [ ] 为搜索功能创建测试
- [ ] 为删除功能创建测试

## 技术约束

- 必须使用 Astro 框架
- 必须支持实时更新
- 必须实现权限控制
- 必须优化性能
- 必须处理错误情况
- 必须保护用户隐私

## 依赖关系

- 依赖 Epic 1 的所有故事完成
- 依赖 Epic 2 的所有故事完成
- 依赖 Epic 3 的所有故事完成
- 依赖 Epic 4 的所有故事完成
- 后续故事将依赖此故事的消息功能

## 风险

- 实时更新可能复杂
- 权限控制可能出错
- 性能可能受影响
- 隐私保护可能不足

## 验收检查清单

- [ ] 消息列表页面正常显示
- [ ] 私信发送功能正常
- [ ] 私信接收功能正常
- [ ] 已读状态正确显示
- [ ] 消息搜索功能正常
- [ ] 消息删除功能正常
- [ ] 性能测试通过
- [ ] 单元测试通过

## 开发者记录

### 完成情况

- [ ] 待开发

### 遇到的问题

- 无

### 技术决策

- 无

### 完成备注

- 无
