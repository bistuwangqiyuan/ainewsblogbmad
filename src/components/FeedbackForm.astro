---
interface Props {
    onSubmit: (data: any) => void;
    onCancel: () => void;
    types?: Array<{
        value: string;
        label: string;
        description: string;
        icon: string;
    }>;
}

const {
    onSubmit,
    onCancel,
    types = [
        {
            value: 'bug',
            label: 'Bug 报告',
            description: '报告系统错误或问题',
            icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>`
        },
        {
            value: 'feature',
            label: '功能建议',
            description: '建议新功能或改进',
            icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
        </svg>`
        },
        {
            value: 'suggestion',
            label: '改进建议',
            description: '对现有功能的改进建议',
            icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
        </svg>`
        },
        {
            value: 'other',
            label: '其他',
            description: '其他类型的反馈',
            icon: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
        </svg>`
        }
    ]
} = Astro.props;
---

<div class="bg-gray-800 rounded-lg p-6">
    <div class="mb-6">
        <h2 class="text-xl font-semibold text-white mb-2">提交反馈</h2>
        <p class="text-gray-400 text-sm">您的反馈对我们很重要，帮助我们不断改进产品</p>
    </div>

    <form id="feedback-form" class="space-y-6">
        <!-- 反馈类型选择 -->
        <div>
            <label class="block text-sm font-medium text-white mb-3">
                反馈类型 <span class="text-red-400">*</span>
            </label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {
                    types.map((type) => (
                        <label class="relative">
                            <input type="radio" name="feedback-type" value={type.value} class="sr-only peer" required />
                            <div class="p-4 border border-gray-600 rounded-lg cursor-pointer transition-all peer-checked:border-blue-500 peer-checked:bg-blue-500/10 hover:border-gray-500">
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 text-blue-400 peer-checked:text-blue-300">
                                        <Fragment set:html={type.icon} />
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-sm font-medium text-white">{type.label}</h3>
                                        <p class="text-xs text-gray-400 mt-1">{type.description}</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    ))
                }
            </div>
        </div>

        <!-- 反馈标题 -->
        <div>
            <label for="feedback-title" class="block text-sm font-medium text-white mb-2">
                反馈标题 <span class="text-red-400">*</span>
            </label>
            <input
                type="text"
                id="feedback-title"
                name="feedback-title"
                placeholder="请简要描述您的反馈"
                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                maxlength="200"
                required
            />
            <div class="flex justify-between items-center mt-1">
                <span class="text-xs text-gray-400">最多200个字符</span>
                <span id="title-count" class="text-xs text-gray-400">0/200</span>
            </div>
        </div>

        <!-- 反馈内容 -->
        <div>
            <label for="feedback-content" class="block text-sm font-medium text-white mb-2">
                详细描述 <span class="text-red-400">*</span>
            </label>
            <textarea
                id="feedback-content"
                name="feedback-content"
                rows="6"
                placeholder="请详细描述您遇到的问题或建议..."
                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 resize-none"
                maxlength="2000"
                required></textarea>
            <div class="flex justify-between items-center mt-1">
                <span class="text-xs text-gray-400">支持Markdown格式，最多2000个字符</span>
                <span id="content-count" class="text-xs text-gray-400">0/2000</span>
            </div>
        </div>

        <!-- 附件上传 -->
        <div>
            <label class="block text-sm font-medium text-white mb-2"> 附件（可选） </label>
            <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-gray-500 transition-colors">
                <input type="file" id="feedback-attachments" name="feedback-attachments" multiple accept="image/*,.pdf,.doc,.docx,.txt" class="hidden" />
                <label for="feedback-attachments" class="cursor-pointer">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <p class="text-gray-400 mb-2">
                        <span class="text-blue-400 hover:text-blue-300">点击上传</span> 或拖拽文件到此处
                    </p>
                    <p class="text-xs text-gray-500">支持图片、PDF、文档等格式，单个文件最大10MB</p>
                </label>
            </div>

            <!-- 已上传文件列表 -->
            <div id="attachments-list" class="mt-4 space-y-2 hidden">
                <!-- 文件列表将通过JavaScript动态添加 -->
            </div>
        </div>

        <!-- 联系方式（可选） -->
        <div>
            <label for="feedback-contact" class="block text-sm font-medium text-white mb-2"> 联系方式（可选） </label>
            <input
                type="text"
                id="feedback-contact"
                name="feedback-contact"
                placeholder="邮箱、微信或其他联系方式"
                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
            />
            <p class="text-xs text-gray-400 mt-1">如果您希望我们回复您的反馈，请留下联系方式</p>
        </div>

        <!-- 操作按钮 -->
        <div class="flex items-center justify-between pt-4 border-t border-gray-700">
            <button type="button" id="cancel-btn" class="px-6 py-2 text-gray-400 hover:text-white transition-colors" onclick="cancelFeedback()"> 取消 </button>
            <div class="flex items-center gap-3">
                <button type="button" id="preview-btn" class="px-4 py-2 text-blue-400 hover:text-blue-300 transition-colors" onclick="previewFeedback()">
                    预览
                </button>
                <button
                    type="submit"
                    id="submit-btn"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                    提交反馈
                </button>
            </div>
        </div>
    </form>
</div>

<!-- 预览模态框 -->
<div id="preview-modal" class="fixed inset-0 bg-black/50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 rounded-lg max-w-2xl w-full p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-white">反馈预览</h3>
                <button id="close-preview" class="text-gray-400 hover:text-white transition-colors" onclick="closePreview()">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div id="preview-content" class="space-y-4">
                <!-- 预览内容将通过JavaScript动态生成 -->
            </div>
            <div class="flex items-center justify-end gap-3 mt-6 pt-4 border-t border-gray-700">
                <button type="button" class="px-4 py-2 text-gray-400 hover:text-white transition-colors" onclick="closePreview()"> 返回编辑 </button>
                <button type="button" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" onclick="submitFromPreview()">
                    确认提交
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // 反馈表单交互逻辑
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('feedback-form');
        const titleInput = document.getElementById('feedback-title') as HTMLInputElement;
        const contentInput = document.getElementById('feedback-content') as HTMLTextAreaElement;
        const titleCount = document.getElementById('title-count');
        const contentCount = document.getElementById('content-count');
        const fileInput = document.getElementById('feedback-attachments') as HTMLInputElement;
        const attachmentsList = document.getElementById('attachments-list');
        const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
        const previewModal = document.getElementById('preview-modal');
        const previewContent = document.getElementById('preview-content');

        let uploadedFiles: File[] = [];

        // 字符计数
        function updateCharCount(input: HTMLInputElement | HTMLTextAreaElement, counter: HTMLElement, maxLength: number) {
            const count = input.value.length;
            counter.textContent = `${count}/${maxLength}`;
            if (count > maxLength * 0.9) {
                counter.classList.add('text-yellow-400');
            } else {
                counter.classList.remove('text-yellow-400');
            }
        }

        titleInput?.addEventListener('input', () => {
            updateCharCount(titleInput, titleCount!, 200);
        });

        contentInput?.addEventListener('input', () => {
            updateCharCount(contentInput, contentCount!, 2000);
        });

        // 文件上传处理
        fileInput?.addEventListener('change', (e) => {
            const files = (e.target as HTMLInputElement).files;
            if (files) {
                handleFileUpload(Array.from(files));
            }
        });

        // 拖拽上传
        const dropZone = document.querySelector('.border-dashed');
        dropZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500');
        });

        dropZone?.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500');
        });

        dropZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            const files = Array.from(e.dataTransfer?.files || []);
            handleFileUpload(files);
        });

        function handleFileUpload(files: File[]) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [
                'image/',
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/'
            ];

            files.forEach((file) => {
                if (file.size > maxSize) {
                    alert(`文件 ${file.name} 超过10MB限制`);
                    return;
                }

                const isValidType = allowedTypes.some((type) => file.type.startsWith(type));
                if (!isValidType) {
                    alert(`文件 ${file.name} 格式不支持`);
                    return;
                }

                uploadedFiles.push(file);
            });

            updateAttachmentsList();
        }

        function updateAttachmentsList() {
            if (!attachmentsList) return;

            if (uploadedFiles.length === 0) {
                attachmentsList.classList.add('hidden');
                return;
            }

            attachmentsList.classList.remove('hidden');
            attachmentsList.innerHTML = uploadedFiles
                .map(
                    (file, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="text-sm text-white">${file.name}</p>
                            <p class="text-xs text-gray-400">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                    </div>
                    <button 
                        type="button"
                        class="text-red-400 hover:text-red-300 transition-colors"
                        onclick="removeFile(${index})"
                    >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            `
                )
                .join('');
        }

        // 表单提交
        form?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('type', (document.querySelector('input[name="feedback-type"]:checked') as HTMLInputElement)?.value || '');
            formData.append('title', titleInput?.value || '');
            formData.append('content', contentInput?.value || '');
            formData.append('contact', (document.getElementById('feedback-contact') as HTMLInputElement)?.value || '');

            uploadedFiles.forEach((file) => {
                formData.append('attachments', file);
            });

            // 触发自定义事件
            const event = new CustomEvent('feedbackSubmit', {
                detail: { formData }
            });
            document.dispatchEvent(event);
        });

        // 全局函数
        (window as any).cancelFeedback = () => {
            const event = new CustomEvent('feedbackCancel');
            document.dispatchEvent(event);
        };

        (window as any).previewFeedback = () => {
            const type = (document.querySelector('input[name="feedback-type"]:checked') as HTMLInputElement)?.value;
            const title = titleInput?.value;
            const content = contentInput?.value;
            const contact = (document.getElementById('feedback-contact') as HTMLInputElement)?.value;

            if (!type || !title || !content) {
                alert('请填写完整的反馈信息');
                return;
            }

            if (previewContent) {
                previewContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-400 mb-2">反馈类型</h4>
                            <p class="text-white">${getTypeLabel(type)}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-400 mb-2">反馈标题</h4>
                            <p class="text-white">${title}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-400 mb-2">详细描述</h4>
                            <div class="text-white whitespace-pre-wrap">${content}</div>
                        </div>
                        ${
                            contact
                                ? `
                            <div>
                                <h4 class="text-sm font-medium text-gray-400 mb-2">联系方式</h4>
                                <p class="text-white">${contact}</p>
                            </div>
                        `
                                : ''
                        }
                        ${
                            uploadedFiles.length > 0
                                ? `
                            <div>
                                <h4 class="text-sm font-medium text-gray-400 mb-2">附件 (${uploadedFiles.length}个文件)</h4>
                                <div class="space-y-2">
                                    ${uploadedFiles
                                        .map(
                                            (file) => `
                                        <div class="flex items-center gap-2 text-sm text-white">
                                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                                            </svg>
                                            ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                                        </div>
                                    `
                                        )
                                        .join('')}
                                </div>
                            </div>
                        `
                                : ''
                        }
                    </div>
                `;
            }

            previewModal?.classList.remove('hidden');
        };

        (window as any).closePreview = () => {
            previewModal?.classList.add('hidden');
        };

        (window as any).submitFromPreview = () => {
            closePreview();
            form?.dispatchEvent(new Event('submit'));
        };

        (window as any).removeFile = (index: number) => {
            uploadedFiles.splice(index, 1);
            updateAttachmentsList();
        };

        function getTypeLabel(value: string): string {
            const typeMap: { [key: string]: string } = {
                bug: 'Bug 报告',
                feature: '功能建议',
                suggestion: '改进建议',
                other: '其他'
            };
            return typeMap[value] || value;
        }
    });
</script>
