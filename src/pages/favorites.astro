---
import Layout from '../layouts/Layout.astro';
---

<Layout title="我的收藏">
    <section>
        <h1 class="text-2xl mb-4">我的收藏</h1>
        <div id="list" class="space-y-3"></div>
        <div class="flex items-center gap-2 mt-6">
            <button id="prev" class="px-3 py-1 bg-white/10 rounded">上一页</button>
            <span id="page">1</span>
            <button id="next" class="px-3 py-1 bg-white/10 rounded">下一页</button>
        </div>
    </section>

    <script>
        import { getSupabaseClient } from '../lib/supabaseClient.js';
        const supabase = getSupabaseClient();
        const PAGE_SIZE = 20;
        let currentPage = 1;

        function linkFor(fav) {
            if (fav.entity_type === 'news') return `/news/${fav.entity_id}`;
            if (fav.entity_type === 'post') return `/post/${fav.entity_id}`;
            if (fav.entity_type === 'answer') return `/post/${fav.entity_id}`; // 跳回问题详情
            return '#';
        }

        async function load(page = 1) {
            const user = (await supabase.auth.getUser()).data.user;
            if (!user) {
                document.getElementById('list').textContent = '请先登录';
                return;
            }
            const fromIdx = (page - 1) * PAGE_SIZE;
            const toIdx = fromIdx + PAGE_SIZE - 1;
            const { data, error, count } = await supabase
                .from('favorites')
                .select('*', { count: 'exact' })
                .eq('user_id', user.id)
                .order('created_at', { ascending: false })
                .range(fromIdx, toIdx);
            if (error) return alert('加载失败：' + error.message);
            const list = document.getElementById('list');
            if (!data.length) {
                list.innerHTML = '<div class="opacity-80">暂无收藏。</div>';
            } else {
                list.innerHTML = data
                    .map(
                        (f) => `<div class="p-3 bg-white/5 rounded text-sm">
          <div class="opacity-80 mb-1">类型：${f.entity_type}</div>
          <a class="underline" href="${linkFor(f)}">进入详情</a>
          <div class="opacity-60 text-xs mt-1">收藏时间：${new Date(f.created_at).toLocaleString()}</div>
        </div>`
                    )
                    .join('');
            }
            document.getElementById('page').textContent = String(page);
            currentPage = page;
            document.getElementById('prev').disabled = page <= 1;
            const maxPage = Math.max(1, Math.ceil((count || 0) / PAGE_SIZE));
            document.getElementById('next').disabled = page >= maxPage;
        }

        document.getElementById('prev').addEventListener('click', () => load(currentPage - 1));
        document.getElementById('next').addEventListener('click', () => load(currentPage + 1));

        load(1);
    </script>
</Layout>
