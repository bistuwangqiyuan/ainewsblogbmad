---
import Layout from '../layouts/Layout.astro';
import TabPanel from '../components/TabPanel.astro';
import PostCard from '../components/PostCard.astro';
import SortFilter from '../components/SortFilter.astro';

// æ’åºé€‰é¡¹
const sortOptions = [
    { value: 'time', label: 'æœ€æ–°å‘å¸ƒ' },
    { value: 'hot', label: 'æœ€çƒ­é—¨' },
    { value: 'reply', label: 'æœ€æ–°å›å¤' }
];

// åˆ†ç±»é€‰é¡¹
const filterOptions = [
    { value: 'tech', label: 'æŠ€æœ¯' },
    { value: 'life', label: 'ç”Ÿæ´»' },
    { value: 'news', label: 'æ–°é—»' },
    { value: 'other', label: 'å…¶ä»–' }
];
---

<Layout title="ç¤¾åŒºï¼šè®ºå› / é—®ç­”">
    <section class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold">ç¤¾åŒº</h1>
            <a href="/compose" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"> å‘å¸– / æé—® </a>
        </div>

        <TabPanel tabs={['è®ºå›', 'é—®ç­”']} activeTab="è®ºå›">
            <div class="mb-6">
                <SortFilter sortOptions={sortOptions} filterOptions={filterOptions} currentSort="time" currentFilter="" />
            </div>

            <div id="posts-list" class="space-y-4">
                <!-- å¸–å­åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>

            <div id="loading" class="text-center py-8 text-gray-400 hidden">åŠ è½½ä¸­...</div>

            <div id="empty" class="text-center py-8 text-gray-400 hidden">æš‚æ— å†…å®¹</div>
        </TabPanel>
    </section>

    <script>
        import { getSupabaseClient } from '../lib/supabaseClient.js';
        const supabase = getSupabaseClient();

        let currentType = 'post';
        let currentSort = 'time';
        let currentFilter = '';
        let currentSearch = '';

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('posts-list').classList.add('hidden');
            document.getElementById('empty').classList.add('hidden');
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('posts-list').classList.remove('hidden');
        }

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmpty() {
            document.getElementById('empty').classList.remove('hidden');
            document.getElementById('posts-list').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // æ„å»ºæŸ¥è¯¢
        function buildQuery() {
            let query = supabase
                .from('posts')
                .select(
                    `
                    id,
                    title,
                    content,
                    created_at,
                    author_id,
                    profiles!posts_author_id_fkey(username),
                    like_count,
                    comment_count
                `
                )
                .eq('type', currentType);

            // æ·»åŠ æ’åº
            switch (currentSort) {
                case 'time':
                    query = query.order('created_at', { ascending: false });
                    break;
                case 'hot':
                    query = query.order('like_count', { ascending: false });
                    break;
                case 'reply':
                    query = query.order('updated_at', { ascending: false });
                    break;
            }

            // æ·»åŠ ç­›é€‰
            if (currentFilter) {
                query = query.eq('category', currentFilter);
            }

            // æ·»åŠ æœç´¢
            if (currentSearch) {
                query = query.or(`title.ilike.%${currentSearch}%,content.ilike.%${currentSearch}%`);
            }

            return query;
        }

        // åŠ è½½å¸–å­åˆ—è¡¨
        async function loadPosts() {
            showLoading();

            try {
                const query = buildQuery();
                const { data, error } = await query;

                if (error) {
                    console.error('åŠ è½½å¤±è´¥:', error);
                    alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
                    return;
                }

                hideLoading();

                const postsList = document.getElementById('posts-list');

                if (!data || data.length === 0) {
                    showEmpty();
                    return;
                }

                postsList.innerHTML = data
                    .map(
                        (post) => `
                    <div class="post-card" data-post-id="${post.id}">
                        <article class="p-4 bg-white/5 rounded-lg hover:bg-white/10 transition-colors">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold">
                                        ${currentType === 'question' ? '?' : 'ğŸ’¬'}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-2">
                                        <a href="/post/${post.id}" class="text-lg font-medium hover:underline text-white">
                                            ${post.title}
                                        </a>
                                        ${currentType === 'question' ? '<span class="px-2 py-1 text-xs bg-orange-500/20 text-orange-300 rounded">é—®ç­”</span>' : ''}
                                    </div>
                                    <p class="text-gray-300 text-sm mb-3 line-clamp-2">
                                        ${(post.content || '').slice(0, 120)}...
                                    </p>
                                    <div class="flex items-center justify-between text-xs text-gray-400">
                                                                            <div class="flex items-center gap-4">
                                        <span>ä½œè€…: ${post.profiles?.username || 'åŒ¿å'}</span>
                                        <span>${new Date(post.created_at).toLocaleDateString('zh-CN')}</span>
                                    </div>
                                        <div class="flex items-center gap-3">
                                            <span class="flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
                                                </svg>
                                                ${post.like_count || 0}
                                            </span>
                                            <span class="flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                                </svg>
                                                ${post.comment_count || 0}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </div>
                `
                    )
                    .join('');
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                hideLoading();
                showEmpty();
            }
        }

        // ç›‘å¬æ ‡ç­¾é¡µåˆ‡æ¢
        document.addEventListener('tabChange', (event: CustomEvent) => {
            const tab = event.detail.tab;
            currentType = tab === 'é—®ç­”' ? 'question' : 'post';
            loadPosts();
        });

        // ç›‘å¬ç­›é€‰å˜åŒ–
        document.addEventListener('filterChange', (event: CustomEvent) => {
            const { sort, filter, search } = event.detail;
            currentSort = sort;
            currentFilter = filter;
            currentSearch = search;
            loadPosts();
        });

        // åˆå§‹åŒ–åŠ è½½
        loadPosts();
    </script>
</Layout>
