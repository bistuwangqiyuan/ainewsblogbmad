---
import Layout from '../layouts/Layout.astro';
---

<Layout 
    title="AI专家问答 - 智能AI助手在线解答 | AI新闻博客"
    description="AI专家问答系统，基于先进的大语言模型，为您解答人工智能、机器学习、深度学习等技术问题。提供专业的技术支持、学习指导和最佳实践建议。"
    keywords="AI问答,人工智能助手,机器学习问答,深度学习教程,AI技术支持,GPT问答,智能助手,AI学习指导,技术咨询"
    breadcrumbs={[
        { name: '首页', url: '/' },
        { name: 'AI问答', url: '/ask' }
    ]}
>
    <section>
        <h1 class="text-2xl mb-4">AI 专家问答</h1>
        <form id="form" class="flex flex-col gap-3 max-w-2xl">
            <textarea id="q" rows="6" class="px-2 py-1 text-black" placeholder="请输入你的问题（公开展示）"></textarea>
            <div class="flex gap-2">
                <button id="btn-submit" class="px-3 py-1 bg-white/10 rounded" type="submit">提交</button>
                <button id="btn-retry" class="px-3 py-1 bg-white/10 rounded" type="button" disabled>重试</button>
            </div>
        </form>
        <div id="answer" class="mt-4 p-3 bg-white/5 rounded whitespace-pre-wrap"></div>
    </section>

    <script>
        import { getSupabaseClient } from '../lib/supabaseClient.js';
        import { formatAiError } from '../lib/ai.js';
        const supabase = getSupabaseClient();

        async function callAsk(question) {
            const user = (await supabase.auth.getUser()).data.user;
            if (!user) throw new Error('请先登录后提问');
            const resp = await fetch('/.netlify/functions/ask-ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, authorId: user.id })
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) throw data || { error: '请求失败' };
            return data;
        }

        async function askFlow() {
            const box = document.getElementById('answer');
            const qEl = document.getElementById('q');
            const submitBtn = document.getElementById('btn-submit');
            const retryBtn = document.getElementById('btn-retry');
            const q = qEl.value.trim();
            if (!q) return;
            box.textContent = '思考中...';
            submitBtn.disabled = true;
            retryBtn.disabled = true;
            try {
                const { answer, postId } = await callAsk(q);
                box.innerHTML = `${answer}\n\n已创建问题：<a class="underline" href="/post/${postId}" target="_blank">查看</a>`;
            } catch (err) {
                const msg = formatAiError(err?.error || err?.message || err, err?.detail);
                box.textContent = '失败：' + msg;
                retryBtn.disabled = false;
            } finally {
                submitBtn.disabled = false;
            }
        }

        document.getElementById('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            askFlow();
        });
        document.getElementById('btn-retry').addEventListener('click', async () => {
            askFlow();
        });
    </script>
</Layout>
